<!doctype html>
<html lang="en-US">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="generator" content="VuePress 2.0.0-rc.19" />
    <style>
      :root {
        --vp-c-bg: #fff;
      }

      [data-theme='dark'] {
        --vp-c-bg: #1b1b1f;
      }

      html,
      body {
        background-color: var(--vp-c-bg);
      }
    </style>
    <script>
      const userMode = localStorage.getItem('vuepress-color-scheme')
      const systemDarkMode =
        'matchMedia' in window
          ? window.matchMedia('(prefers-color-scheme: dark)').matches
          : false

      if (userMode === 'light') {
        document.documentElement.dataset.theme = 'light'
      } else if (userMode === 'dark' || systemDarkMode) {
        document.documentElement.dataset.theme = 'dark'
      }
    </script>
    <title>VPC 내부 람다의 외부 통신 문제 | 앤디 블로그</title><meta name="description" content="간단한 결제 시스템을 람다로 만들면서 발생한 통신 문제입니다.">
    <link rel="preload" href="/assets/style-D4Ug0Rbq.css" as="style"><link rel="stylesheet" href="/assets/style-D4Ug0Rbq.css">
    <link rel="modulepreload" href="/assets/app-C0zayjsd.js"><link rel="modulepreload" href="/assets/2023-12-15-awslambda.html-aZxHdjtC.js">
    <link rel="prefetch" href="/assets/index.html-D19DMQRb.js" as="script"><link rel="prefetch" href="/assets/index.html-CfpDe-U8.js" as="script"><link rel="prefetch" href="/assets/index.html-CdDjf6y6.js" as="script"><link rel="prefetch" href="/assets/index.html-Do9MWh--.js" as="script"><link rel="prefetch" href="/assets/index.html-BhVW-NjM.js" as="script"><link rel="prefetch" href="/assets/2023-11-18-system.html-CYS9ZzsO.js" as="script"><link rel="prefetch" href="/assets/2025-02-08-whatiswork.html-CsQqgEGu.js" as="script"><link rel="prefetch" href="/assets/2025-02-11-kafka.html-BKm2lzHt.js" as="script"><link rel="prefetch" href="/assets/2025-02-16-object.html-BOUnVcYC.js" as="script"><link rel="prefetch" href="/assets/2025-03-03-skilloflove.html-DMff2Qw6.js" as="script"><link rel="prefetch" href="/assets/2025-03-08-terraform.html-66lI0ji2.js" as="script"><link rel="prefetch" href="/assets/2025-03-09-software.html-DYyCTIec.js" as="script"><link rel="prefetch" href="/assets/2025-03-23-chosun.html-C_auxR5D.js" as="script"><link rel="prefetch" href="/assets/2025-08-31-unittest.html-DiLsUReL.js" as="script"><link rel="prefetch" href="/assets/2025-02-07-ze.html-BhiuO7fD.js" as="script"><link rel="prefetch" href="/assets/2025-02-10-firstlog.html-BllbrNgk.js" as="script"><link rel="prefetch" href="/assets/2025-02-14-log.html-DTCkhuLG.js" as="script"><link rel="prefetch" href="/assets/2025-02-23-anna.html-Ct4rskAB.js" as="script"><link rel="prefetch" href="/assets/2025-03-02-bystander.html-DOvcd2K-.js" as="script"><link rel="prefetch" href="/assets/2025-04-08-k8s.html-CmxOk0oW.js" as="script"><link rel="prefetch" href="/assets/2025-04-20-log.html-DnvNjrrn.js" as="script"><link rel="prefetch" href="/assets/2025-08-18-coworker.html-CpTIfW8L.js" as="script"><link rel="prefetch" href="/assets/2025-02-25-aws.html-wuSIjAaM.js" as="script"><link rel="prefetch" href="/assets/2025-03-13-aws.html-B6fkQ4Jw.js" as="script"><link rel="prefetch" href="/assets/2025-03-20-aws.html-7Idrv63G.js" as="script"><link rel="prefetch" href="/assets/index.html-B_9p0kVc.js" as="script"><link rel="prefetch" href="/assets/2025-08-26-culture1.html-C7IzVoi1.js" as="script"><link rel="prefetch" href="/assets/2025-08-27-culturetest.html-DzMzIUak.js" as="script"><link rel="prefetch" href="/assets/index.html-BqMxAtq4.js" as="script"><link rel="prefetch" href="/assets/2025-04-20-leteraljoin.html-DEqt0LZN.js" as="script"><link rel="prefetch" href="/assets/index.html-C15Un2vm.js" as="script"><link rel="prefetch" href="/assets/2023-10-20-cpucredit.html-qu-7KQFa.js" as="script"><link rel="prefetch" href="/assets/2024-05-23-goodlog.html-LoitNwTI.js" as="script"><link rel="prefetch" href="/assets/2024-10-28-sg.html-7NokSH-L.js" as="script"><link rel="prefetch" href="/assets/2025-01-24-eksdnsresolve.html-BYvSpDi_.js" as="script"><link rel="prefetch" href="/assets/2025-03-15-filesystem.html-CvJuVxiW.js" as="script"><link rel="prefetch" href="/assets/2025-05-04-awsregion.html-C4kmR5O-.js" as="script"><link rel="prefetch" href="/assets/2025-09-03-kuberesource.html-C7hqu3cY.js" as="script"><link rel="prefetch" href="/assets/2025-09-05-podeviction.html-D_1oBzDH.js" as="script"><link rel="prefetch" href="/assets/index.html-CsXZmCyx.js" as="script"><link rel="prefetch" href="/assets/2025-01-18-kafkadocker.html-C7sA2BUP.js" as="script"><link rel="prefetch" href="/assets/2025-09-07-kafkaerror.html-CyAO4ujs.js" as="script"><link rel="prefetch" href="/assets/index.html-CyiIHame.js" as="script"><link rel="prefetch" href="/assets/2023-04-12-validation.html-Bnonxgdk.js" as="script"><link rel="prefetch" href="/assets/2023-04-18-rtr.html-CN7FA6QA.js" as="script"><link rel="prefetch" href="/assets/2023-04-25-mdc.html-D0aozE0v.js" as="script"><link rel="prefetch" href="/assets/2023-05-10-SpringRestDocs1.html-61HYrLb3.js" as="script"><link rel="prefetch" href="/assets/2023-05-13-SpringRestDocs2.html-4KxqNcyK.js" as="script"><link rel="prefetch" href="/assets/2023-05-14-SpringRestDocs3.html-JMXbBw52.js" as="script"><link rel="prefetch" href="/assets/2025-02-13-security.html-C9FxtlC7.js" as="script"><link rel="prefetch" href="/assets/2025-06-25-alarm.html-BRjRqXQl.js" as="script"><link rel="prefetch" href="/assets/2025-07-20-ssewebsocket.html-BxVRVETH.js" as="script"><link rel="prefetch" href="/assets/2025-08-05-test1.html-CLcxymPv.js" as="script"><link rel="prefetch" href="/assets/2025-08-20-test2.html-DwMhCYW2.js" as="script"><link rel="prefetch" href="/assets/2025-08-28-jsonproperty.html-BujsH6mo.js" as="script"><link rel="prefetch" href="/assets/2025-09-08-sonarqube.html-DSZaY-zm.js" as="script"><link rel="prefetch" href="/assets/index.html-CyVznNNs.js" as="script"><link rel="prefetch" href="/assets/2025-01-01-list.html-DL0jm8pQ.js" as="script"><link rel="prefetch" href="/assets/2025-06-27-iot.html-3OSxpYLe.js" as="script"><link rel="prefetch" href="/assets/2025-07-20-ssewebsocket.html-Bq-ALBZa.js" as="script"><link rel="prefetch" href="/assets/2025-08-13-mqtt.html-DXBnCixg.js" as="script"><link rel="prefetch" href="/assets/2025-08-29-oidc.html-BVbjdxJS.js" as="script"><link rel="prefetch" href="/assets/2025-09-04-smtp.html-DysprWn7.js" as="script"><link rel="prefetch" href="/assets/index.html-BpowS9Ak.js" as="script"><link rel="prefetch" href="/assets/404.html-Ce5F9RaY.js" as="script"><link rel="prefetch" href="/assets/setupDevtools-7MC2TMWH-b3L_XbaG.js" as="script">
  </head>
  <body>
    <div id="app"><!--[--><div class="vp-theme-container external-link-icon" vp-container><!--[--><header class="vp-navbar" vp-navbar><div class="vp-toggle-sidebar-button" title="toggle sidebar" aria-expanded="false" role="button" tabindex="0"><div class="icon" aria-hidden="true"><span></span><span></span><span></span></div></div><span><a class="route-link" href="/"><!----><span class="vp-site-name" aria-hidden="true">앤디 블로그</span></a></span><div class="vp-navbar-items-wrapper" style=""><!--[--><!--]--><nav class="vp-navbar-items vp-hide-mobile" aria-label="site navigation"><!--[--><div class="vp-navbar-item"><div class="vp-navbar-dropdown-wrapper"><button class="vp-navbar-dropdown-title" type="button" aria-label="글"><span class="title">글</span><span class="arrow down"></span></button><button class="vp-navbar-dropdown-title-mobile" type="button" aria-label="글"><span class="title">글</span><span class="right arrow"></span></button><ul style="display:none;" class="vp-navbar-dropdown"><!--[--><li class="vp-navbar-dropdown-item"><a class="route-link route-link-active auto-link" href="/posts/" aria-label="모두"><!--[--><!--[--><!--]--><!--]-->모두<!--[--><!--[--><!--]--><!--]--></a></li><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/posts/culture/" aria-label="개발 문화"><!--[--><!--[--><!--]--><!--]-->개발 문화<!--[--><!--[--><!--]--><!--]--></a></li><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/posts/tech/" aria-label="기술"><!--[--><!--[--><!--]--><!--]-->기술<!--[--><!--[--><!--]--><!--]--></a></li><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/posts/kafka/" aria-label="카프카"><!--[--><!--[--><!--]--><!--]-->카프카<!--[--><!--[--><!--]--><!--]--></a></li><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/posts/spring/" aria-label="스프링"><!--[--><!--[--><!--]--><!--]-->스프링<!--[--><!--[--><!--]--><!--]--></a></li><li class="vp-navbar-dropdown-item"><a class="route-link route-link-active auto-link" href="/posts/infra/" aria-label="인프라"><!--[--><!--[--><!--]--><!--]-->인프라<!--[--><!--[--><!--]--><!--]--></a></li><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/posts/database/" aria-label="데이터베이스"><!--[--><!--[--><!--]--><!--]-->데이터베이스<!--[--><!--[--><!--]--><!--]--></a></li><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/posts/conference/" aria-label="컨퍼런스"><!--[--><!--[--><!--]--><!--]-->컨퍼런스<!--[--><!--[--><!--]--><!--]--></a></li><!--]--></ul></div></div><div class="vp-navbar-item"><a class="route-link auto-link" href="/books/" aria-label="책"><!--[--><!--[--><!--]--><!--]-->책<!--[--><!--[--><!--]--><!--]--></a></div><div class="vp-navbar-item"><a class="route-link auto-link" href="/logs/" aria-label="짧은 글"><!--[--><!--[--><!--]--><!--]-->짧은 글<!--[--><!--[--><!--]--><!--]--></a></div><div class="vp-navbar-item"><a class="route-link auto-link" href="/resume/" aria-label="이력서"><!--[--><!--[--><!--]--><!--]-->이력서<!--[--><!--[--><!--]--><!--]--></a></div><!--]--></nav><!--[--><!--]--><button type="button" class="vp-toggle-color-mode-button" title="toggle color mode"><svg class="light-icon" viewbox="0 0 32 32" style=""><path d="M16 12.005a4 4 0 1 1-4 4a4.005 4.005 0 0 1 4-4m0-2a6 6 0 1 0 6 6a6 6 0 0 0-6-6z" fill="currentColor"></path><path d="M5.394 6.813l1.414-1.415l3.506 3.506L8.9 10.318z" fill="currentColor"></path><path d="M2 15.005h5v2H2z" fill="currentColor"></path><path d="M5.394 25.197L8.9 21.691l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 25.005h2v5h-2z" fill="currentColor"></path><path d="M21.687 23.106l1.414-1.415l3.506 3.506l-1.414 1.414z" fill="currentColor"></path><path d="M25 15.005h5v2h-5z" fill="currentColor"></path><path d="M21.687 8.904l3.506-3.506l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 2.005h2v5h-2z" fill="currentColor"></path></svg><svg class="dark-icon" viewbox="0 0 32 32" style="display:none;"><path d="M13.502 5.414a15.075 15.075 0 0 0 11.594 18.194a11.113 11.113 0 0 1-7.975 3.39c-.138 0-.278.005-.418 0a11.094 11.094 0 0 1-3.2-21.584M14.98 3a1.002 1.002 0 0 0-.175.016a13.096 13.096 0 0 0 1.825 25.981c.164.006.328 0 .49 0a13.072 13.072 0 0 0 10.703-5.555a1.01 1.01 0 0 0-.783-1.565A13.08 13.08 0 0 1 15.89 4.38A1.015 1.015 0 0 0 14.98 3z" fill="currentColor"></path></svg></button><!----></div></header><!--]--><div class="vp-sidebar-mask"></div><!--[--><aside class="vp-sidebar" vp-sidebar><nav class="vp-navbar-items" aria-label="site navigation"><!--[--><div class="vp-navbar-item"><div class="vp-navbar-dropdown-wrapper"><button class="vp-navbar-dropdown-title" type="button" aria-label="글"><span class="title">글</span><span class="arrow down"></span></button><button class="vp-navbar-dropdown-title-mobile" type="button" aria-label="글"><span class="title">글</span><span class="right arrow"></span></button><ul style="display:none;" class="vp-navbar-dropdown"><!--[--><li class="vp-navbar-dropdown-item"><a class="route-link route-link-active auto-link" href="/posts/" aria-label="모두"><!--[--><!--[--><!--]--><!--]-->모두<!--[--><!--[--><!--]--><!--]--></a></li><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/posts/culture/" aria-label="개발 문화"><!--[--><!--[--><!--]--><!--]-->개발 문화<!--[--><!--[--><!--]--><!--]--></a></li><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/posts/tech/" aria-label="기술"><!--[--><!--[--><!--]--><!--]-->기술<!--[--><!--[--><!--]--><!--]--></a></li><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/posts/kafka/" aria-label="카프카"><!--[--><!--[--><!--]--><!--]-->카프카<!--[--><!--[--><!--]--><!--]--></a></li><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/posts/spring/" aria-label="스프링"><!--[--><!--[--><!--]--><!--]-->스프링<!--[--><!--[--><!--]--><!--]--></a></li><li class="vp-navbar-dropdown-item"><a class="route-link route-link-active auto-link" href="/posts/infra/" aria-label="인프라"><!--[--><!--[--><!--]--><!--]-->인프라<!--[--><!--[--><!--]--><!--]--></a></li><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/posts/database/" aria-label="데이터베이스"><!--[--><!--[--><!--]--><!--]-->데이터베이스<!--[--><!--[--><!--]--><!--]--></a></li><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/posts/conference/" aria-label="컨퍼런스"><!--[--><!--[--><!--]--><!--]-->컨퍼런스<!--[--><!--[--><!--]--><!--]--></a></li><!--]--></ul></div></div><div class="vp-navbar-item"><a class="route-link auto-link" href="/books/" aria-label="책"><!--[--><!--[--><!--]--><!--]-->책<!--[--><!--[--><!--]--><!--]--></a></div><div class="vp-navbar-item"><a class="route-link auto-link" href="/logs/" aria-label="짧은 글"><!--[--><!--[--><!--]--><!--]-->짧은 글<!--[--><!--[--><!--]--><!--]--></a></div><div class="vp-navbar-item"><a class="route-link auto-link" href="/resume/" aria-label="이력서"><!--[--><!--[--><!--]--><!--]-->이력서<!--[--><!--[--><!--]--><!--]--></a></div><!--]--></nav><!--[--><!--]--><ul class="vp-sidebar-items"><!--[--><li><p tabindex="0" class="vp-sidebar-item vp-sidebar-heading">VPC 내부 람다의 외부 통신 문제 <!----></p><ul style="" class="vp-sidebar-children"><!--[--><li><a class="route-link auto-link vp-sidebar-item" href="#문제상황" aria-label="문제상황"><!--[--><!--[--><!--]--><!--]-->문제상황<!--[--><!--[--><!--]--><!--]--></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="#해결" aria-label="해결"><!--[--><!--[--><!--]--><!--]-->해결<!--[--><!--[--><!--]--><!--]--></a><!----></li><!--]--></ul></li><!--]--></ul><!--[--><!--]--></aside><!--]--><!--[--><main class="vp-page"><!--[--><!--]--><div vp-content><!--[--><!--]--><div><header class="page-header" data-v-84f05ea1><h1 class="title" data-v-84f05ea1>VPC 내부 람다의 외부 통신 문제</h1><div class="meta" data-v-84f05ea1><time data-v-84f05ea1>2023년 12월 15일</time></div></header><nav class="table-of-contents"><ul><li><a aria-current="page" href="/posts/infra/2023-12-15-awslambda.html#문제상황" class="router-link-active router-link-exact-active">문제상황</a></li><li><a aria-current="page" href="/posts/infra/2023-12-15-awslambda.html#해결" class="router-link-active router-link-exact-active">해결</a></li></ul></nav><p>스프링 코드를 API Gateway + Lambda 로 배포하면서 겪은 문제다.</p><h2 id="문제상황" tabindex="-1"><a class="header-anchor" href="#문제상황"><span>문제상황</span></a></h2><p>먼저 아키텍처는 아래와 같이 간단하게 설명할 수 있다.</p><ul><li>유저가 람다 서비스로 결제 요청</li><li>람다 서비스는 결제 서버와 통신 후 결제 결과를 DB 에 저장</li><li>결제 결과를 유저에게 반환(주로 리다이렉트)</li></ul><p><img src="/images/2023-12-15-awslambda/image-20250907234300488.png" alt="image-20250907234300488"></p><p>이 때 DB 조회만 있는 로직은 잘 수행되었지만 (결제해야 할 가격 조회 등) 결제 서버와의 통신이 필요한 로직은 람다 timeout 이 발생했다. 따라서 내부적으로 로직이 오래걸리거나 timeout 이 발생할 내용이 있다는 건데, <strong>로컬에서는 잘 수행되었으므로 결제 서버와의 통신이 잘 안된다고 판단했다.</strong> 하지만 lambda 는 public 서브넷에 있었고, 당연히 IGW 로 통신이 될 것이라고 생각했기 때문에 공식문서부터 찾아보았다.</p><h2 id="해결" tabindex="-1"><a class="header-anchor" href="#해결"><span>해결</span></a></h2><p><a href="https://docs.aws.amazon.com/ko_kr/lambda/latest/dg/configuration-vpc.html#vpc-setup-guidelines" target="_blank" rel="noopener noreferrer">AWS 공식문서</a> 에는 다음과 같이 적혀있다.</p><blockquote><p>... 프라이빗 서브넷에서의 인터넷 액세스에는 NAT(Network Address Translation)가 필요합니다. 함수에 인터넷 액세스 권한을 부여하려면 아웃바운드 트래픽을 퍼블릭 서브넷의 NAT 게이트웨이로 라우팅합니다. NAT 게이트웨이는 퍼블릭 IP 주소가 있으므로 VPC의 인터넷 게이트웨이를 통해 인터넷에 연결할 수 있습니다. ...</p></blockquote><p><strong>결론적으로 서브넷과 NAT Gateway 가 연결되어야 한다.</strong> 그리고 찾아본 바로는 Lambda 함수가 특정한 IGW 를 통해 직접 퍼블릭 인터넷으로 나가는 것을 허용하지 않는다. 따라서 람다의 서브넷이 public subnet 이라고 하더라도, NAT Gateway 로 연결되는 라우팅 테이블이 있는지 확인해봐야 한다.</p><p>회사 서버에서 서브넷은 총 5개로, public subnet 4개와 private subnet 1개가 있었는데 private subnet 에만 NAT Gateway 가 연결되어 있었따. 그리고 람다는 5개 서브넷 중 1개에서 실행되는 것으로 되어있었다. 따라서 방법은 아래 두 가지다.</p><ul><li>public subnet 과 NAT Gateway 연결</li><li>람다를 private subnet 에서만 실행</li></ul><p>나는 여기서 두 번째 방법을 선택했는데, 전체적인 구성을 변경하지 않으면서도 목적을 달성할 수 있기 때문이다. 결제 서비스의 경우 고객사를 대상으로 하기 때문에 실행 수가 많지 않아 고가용성이 요구되지 않았다. 람다의 Configuration &gt; VPC 탭에서 서브넷을 private subnet 만 선택하는 걸로 해결했다.</p><nav class="vp-page-nav" aria-label="page navigation" data-v-63cabaa2><!----><!----></nav></div><!--[--><!--]--></div><footer class="vp-page-meta"><!----><div class="vp-meta-item git-info"><!----><!----></div></footer><!----><!--[--><!--]--></main><!--]--></div><!--[--><!----><!--]--><!--]--></div>
    <script type="module" src="/assets/app-C0zayjsd.js" defer></script>
  </body>
</html>
