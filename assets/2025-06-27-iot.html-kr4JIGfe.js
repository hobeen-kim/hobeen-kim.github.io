import{_ as c,c as u,a,b as s,d as r,f as t,r as p,o as d,e as l}from"./app-DUIsGCIT.js";const k="/images/2025-06-27-iot/image-20250627105439418.png",v="/images/2025-06-27-iot/image-20250627110412819.png",m={},b={class:"table-of-contents"};function h(g,n){const i=p("Header"),e=p("router-link"),o=p("Footer");return d(),u("div",null,[a(i),s("nav",b,[s("ul",null,[s("li",null,[a(e,{to:"#_1-shadow-디바이스-상태를-안전하게-관리하는-핵심-기능"},{default:t(()=>n[0]||(n[0]=[l("1. Shadow: 디바이스 상태를 안전하게 관리하는 핵심 기능")])),_:1}),s("ul",null,[s("li",null,[a(e,{to:"#shadow가-뭔가요"},{default:t(()=>n[1]||(n[1]=[l("Shadow가 뭔가요?")])),_:1})]),s("li",null,[a(e,{to:"#왜-필요한가"},{default:t(()=>n[2]||(n[2]=[l("왜 필요한가?")])),_:1}),s("ul",null,[s("li",null,[a(e,{to:"#디바이스가-오프라인일-때"},{default:t(()=>n[3]||(n[3]=[l("디바이스가 오프라인일 때")])),_:1})]),s("li",null,[a(e,{to:"#여러-앱에서-동시에-접근할-때"},{default:t(()=>n[4]||(n[4]=[l("여러 앱에서 동시에 접근할 때")])),_:1})])])]),s("li",null,[a(e,{to:"#shadow의-구조"},{default:t(()=>n[5]||(n[5]=[l("Shadow의 구조")])),_:1}),s("ul",null,[s("li",null,[a(e,{to:"#동기화-과정"},{default:t(()=>n[6]||(n[6]=[l("동기화 과정")])),_:1})])])]),s("li",null,[a(e,{to:"#named-shadow-vs-unnamed-shadow"},{default:t(()=>n[7]||(n[7]=[l("Named Shadow vs Unnamed Shadow")])),_:1})])])]),s("li",null,[a(e,{to:"#_2-인증서와-보안-iot-디바이스의-신원-증명"},{default:t(()=>n[8]||(n[8]=[l("2. 인증서와 보안: IoT 디바이스의 신원 증명")])),_:1}),s("ul",null,[s("li",null,[a(e,{to:"#필수-인증서-파일들"},{default:t(()=>n[9]||(n[9]=[l("필수 인증서 파일들")])),_:1}),s("ul",null,[s("li",null,[a(e,{to:"#_1-certificate-pem-crt-클라이언트-인증서"},{default:t(()=>n[10]||(n[10]=[l("1. certificate.pem.crt (클라이언트 인증서)")])),_:1})]),s("li",null,[a(e,{to:"#_2-private-key-pem-개인-키"},{default:t(()=>n[11]||(n[11]=[l("2. private-key.pem (개인 키)")])),_:1})]),s("li",null,[a(e,{to:"#_3-rootca1-pem-루트-인증서"},{default:t(()=>n[12]||(n[12]=[l("3. rootCA1.pem (루트 인증서)")])),_:1})])])]),s("li",null,[a(e,{to:"#tls-mutual-authentication-과정"},{default:t(()=>n[13]||(n[13]=[l("TLS Mutual Authentication 과정")])),_:1}),s("ul",null,[s("li",null,[a(e,{to:"#_1단계-서버-인증-디바이스-→-aws-검증"},{default:t(()=>n[14]||(n[14]=[l("1단계: 서버 인증 (디바이스 → AWS 검증)")])),_:1})]),s("li",null,[a(e,{to:"#_2단계-클라이언트-인증-aws-→-디바이스-검증"},{default:t(()=>n[15]||(n[15]=[l("2단계: 클라이언트 인증 (AWS → 디바이스 검증)")])),_:1})]),s("li",null,[a(e,{to:"#_3단계-tls-세션-성립"},{default:t(()=>n[16]||(n[16]=[l("3단계: TLS 세션 성립")])),_:1})])])])])]),s("li",null,[a(e,{to:"#_3-실제-python-코드로-보는-shadow-활용"},{default:t(()=>n[17]||(n[17]=[l("3. 실제 Python 코드로 보는 Shadow 활용")])),_:1}),s("ul",null,[s("li",null,[a(e,{to:"#기본-연결-설정"},{default:t(()=>n[18]||(n[18]=[l("기본 연결 설정")])),_:1})]),s("li",null,[a(e,{to:"#shadow-콜백-함수들"},{default:t(()=>n[19]||(n[19]=[l("Shadow 콜백 함수들")])),_:1}),s("ul",null,[s("li",null,[a(e,{to:"#delta-콜백-원격-제어-받기"},{default:t(()=>n[20]||(n[20]=[l("Delta 콜백: 원격 제어 받기")])),_:1})]),s("li",null,[a(e,{to:"#update-콜백-상태-업데이트-결과-확인"},{default:t(()=>n[21]||(n[21]=[l("Update 콜백: 상태 업데이트 결과 확인")])),_:1})])])]),s("li",null,[a(e,{to:"#실무-팁"},{default:t(()=>n[22]||(n[22]=[l("실무 팁")])),_:1}),s("ul",null,[s("li",null,[a(e,{to:"#연결-안정성-향상"},{default:t(()=>n[23]||(n[23]=[l("연결 안정성 향상")])),_:1})]),s("li",null,[a(e,{to:"#에러-처리"},{default:t(()=>n[24]||(n[24]=[l("에러 처리")])),_:1})])])])])]),s("li",null,[a(e,{to:"#_4-job-대규모-디바이스-관리의-핵심"},{default:t(()=>n[25]||(n[25]=[l("4. Job: 대규모 디바이스 관리의 핵심")])),_:1}),s("ul",null,[s("li",null,[a(e,{to:"#job이-필요한-이유"},{default:t(()=>n[26]||(n[26]=[l("Job이 필요한 이유")])),_:1})]),s("li",null,[a(e,{to:"#shadow-vs-job-비교"},{default:t(()=>n[27]||(n[27]=[l("Shadow vs Job 비교")])),_:1})]),s("li",null,[a(e,{to:"#job-document-구조"},{default:t(()=>n[28]||(n[28]=[l("Job Document 구조")])),_:1}),s("ul",null,[s("li",null,[a(e,{to:"#예시-1-펌웨어-업데이트"},{default:t(()=>n[29]||(n[29]=[l("예시 1: 펌웨어 업데이트")])),_:1})]),s("li",null,[a(e,{to:"#예시-2-설정-변경"},{default:t(()=>n[30]||(n[30]=[l("예시 2: 설정 변경")])),_:1})]),s("li",null,[a(e,{to:"#예시-3-단순-명령"},{default:t(()=>n[31]||(n[31]=[l("예시 3: 단순 명령")])),_:1})])])]),s("li",null,[a(e,{to:"#job-생성-및-관리"},{default:t(()=>n[32]||(n[32]=[l("Job 생성 및 관리")])),_:1}),s("ul",null,[s("li",null,[a(e,{to:"#cli로-job-생성"},{default:t(()=>n[33]||(n[33]=[l("CLI로 Job 생성")])),_:1})]),s("li",null,[a(e,{to:"#디바이스에서-job-처리"},{default:t(()=>n[34]||(n[34]=[l("디바이스에서 Job 처리")])),_:1})])])])])]),s("li",null,[a(e,{to:"#_5-실무에서-배운-교훈들"},{default:t(()=>n[35]||(n[35]=[l("5. 실무에서 배운 교훈들")])),_:1}),s("ul",null,[s("li",null,[a(e,{to:"#디바이스-오프라인-대응"},{default:t(()=>n[36]||(n[36]=[l("디바이스 오프라인 대응")])),_:1})]),s("li",null,[a(e,{to:"#대규모-배포시-주의사항"},{default:t(()=>n[37]||(n[37]=[l("대규모 배포시 주의사항")])),_:1})]),s("li",null,[a(e,{to:"#보안-관련-팁"},{default:t(()=>n[38]||(n[38]=[l("보안 관련 팁")])),_:1}),s("ul",null,[s("li",null,[a(e,{to:"#_1-인증서-로테이션"},{default:t(()=>n[39]||(n[39]=[l("1. 인증서 로테이션")])),_:1})]),s("li",null,[a(e,{to:"#_2-정책-최소권한-원칙"},{default:t(()=>n[40]||(n[40]=[l("2. 정책 최소권한 원칙")])),_:1})])])])])]),s("li",null,[a(e,{to:"#_6-메시지-크기-최적화-비용-절약의-핵심"},{default:t(()=>n[41]||(n[41]=[l("6. 메시지 크기 최적화: 비용 절약의 핵심")])),_:1}),s("ul",null,[s("li",null,[a(e,{to:"#aws-iot-core-실제-과금-방식"},{default:t(()=>n[42]||(n[42]=[l("AWS IoT Core 실제 과금 방식")])),_:1}),s("ul",null,[s("li",null,[a(e,{to:"#실제-과금-구조"},{default:t(()=>n[43]||(n[43]=[l("실제 과금 구조")])),_:1})])])]),s("li",null,[a(e,{to:"#실제-비용-영향-사례"},{default:t(()=>n[44]||(n[44]=[l("실제 비용 영향 사례")])),_:1}),s("ul",null,[s("li",null,[a(e,{to:"#before-최적화-8kb-센서-데이터"},{default:t(()=>n[45]||(n[45]=[l("Before 최적화 (8KB 센서 데이터)")])),_:1})]),s("li",null,[a(e,{to:"#after-최적화-4-2kb-압축-데이터"},{default:t(()=>n[46]||(n[46]=[l("After 최적화 (4.2KB 압축 데이터)")])),_:1})])])]),s("li",null,[a(e,{to:"#월별-비용-차이-계산"},{default:t(()=>n[47]||(n[47]=[l("월별 비용 차이 계산")])),_:1}),s("ul",null,[s("li",null,[a(e,{to:"#_8kb-메시지-최적화-전"},{default:t(()=>n[48]||(n[48]=[l("8KB 메시지 (최적화 전)")])),_:1})]),s("li",null,[a(e,{to:"#_4-2kb-메시지-최적화-후"},{default:t(()=>n[49]||(n[49]=[l("4.2KB 메시지 (최적화 후)")])),_:1})])])]),s("li",null,[a(e,{to:"#실무-최적화-기법들"},{default:t(()=>n[50]||(n[50]=[l("실무 최적화 기법들")])),_:1}),s("ul",null,[s("li",null,[a(e,{to:"#_1-json-키-이름-축약"},{default:t(()=>n[51]||(n[51]=[l("1. JSON 키 이름 축약")])),_:1})]),s("li",null,[a(e,{to:"#_2-데이터-타입-최적화"},{default:t(()=>n[52]||(n[52]=[l("2. 데이터 타입 최적화")])),_:1})]),s("li",null,[a(e,{to:"#_3-배열-데이터-압축"},{default:t(()=>n[53]||(n[53]=[l("3. 배열 데이터 압축")])),_:1})]),s("li",null,[a(e,{to:"#_4-gzip-압축-활용"},{default:t(()=>n[54]||(n[54]=[l("4. GZIP 압축 활용")])),_:1})])])]),s("li",null,[a(e,{to:"#메시지-크기-모니터링-도구"},{default:t(()=>n[55]||(n[55]=[l("메시지 크기 모니터링 도구")])),_:1})]),s("li",null,[a(e,{to:"#배치-전송으로-효율성-극대화"},{default:t(()=>n[56]||(n[56]=[l("배치 전송으로 효율성 극대화")])),_:1})]),s("li",null,[a(e,{to:"#다른-aws-iot-서비스들도-마찬가지"},{default:t(()=>n[57]||(n[57]=[l("다른 AWS IoT 서비스들도 마찬가지")])),_:1}),s("ul",null,[s("li",null,[a(e,{to:"#device-shadow"},{default:t(()=>n[58]||(n[58]=[l("Device Shadow")])),_:1})]),s("li",null,[a(e,{to:"#rules-engine"},{default:t(()=>n[59]||(n[59]=[l("Rules Engine")])),_:1})])])]),s("li",null,[a(e,{to:"#핵심-권장사항"},{default:t(()=>n[60]||(n[60]=[l("핵심 권장사항")])),_:1})])])])])]),a(i),n[61]||(n[61]=r('<p>최근 IoT 프로젝트를 진행하면서 AWS IoT Core를 깊이 사용하게 되었다. 처음엔 단순히 디바이스를 클라우드에 연결하는 정도로 생각했는데, 막상 써보니 Shadow, 인증서, Job 등 알아야 할 개념들이 생각보다 많았다. 특히 Shadow의 경우 처음엔 &quot;왜 굳이?&quot;라는 생각이 들었지만, 실제 디바이스가 오프라인 상황을 겪어보니 그 필요성을 절실히 느꼈다.</p><p>이번 글에서는 AWS IoT Core의 핵심 개념들을 실무에서 겪은 경험을 바탕으로 정리해보려고 한다.</p><hr><h1 id="_1-shadow-디바이스-상태를-안전하게-관리하는-핵심-기능" tabindex="-1"><a class="header-anchor" href="#_1-shadow-디바이스-상태를-안전하게-관리하는-핵심-기능"><span>1. Shadow: 디바이스 상태를 안전하게 관리하는 핵심 기능</span></a></h1><h2 id="shadow가-뭔가요" tabindex="-1"><a class="header-anchor" href="#shadow가-뭔가요"><span>Shadow가 뭔가요?</span></a></h2><p>AWS IoT Core의 Shadow는 <strong>디바이스의 상태를 클라우드에 저장해 놓은 JSON 문서</strong>다. 간단히 말해, 우리집 IoT 전구의 현재 상태(켜짐/꺼짐, 밝기 등)를 AWS 클라우드에 복사본으로 저장해두는 것이다.</p><p><img src="'+k+`" alt="image-20250627105439418"></p><div class="language-json line-numbers-mode" data-highlighter="prismjs" data-ext="json" data-title="json"><pre><code><span class="line"><span class="token punctuation">{</span></span>
<span class="line">  <span class="token property">&quot;state&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token property">&quot;desired&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token property">&quot;power&quot;</span><span class="token operator">:</span> <span class="token string">&quot;on&quot;</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token property">&quot;brightness&quot;</span><span class="token operator">:</span> <span class="token number">70</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token property">&quot;reported&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token property">&quot;power&quot;</span><span class="token operator">:</span> <span class="token string">&quot;on&quot;</span><span class="token punctuation">,</span> </span>
<span class="line">      <span class="token property">&quot;brightness&quot;</span><span class="token operator">:</span> <span class="token number">70</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">  <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token property">&quot;metadata&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>...<span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token property">&quot;timestamp&quot;</span><span class="token operator">:</span> <span class="token number">1629393746</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="왜-필요한가" tabindex="-1"><a class="header-anchor" href="#왜-필요한가"><span>왜 필요한가?</span></a></h2><p>처음엔 &quot;디바이스에 직접 명령 보내면 되는데 왜 굳이?&quot;라고 생각했다. 하지만 실제 IoT 환경에서는 다음과 같은 상황들이 빈번히 발생한다:</p><h3 id="디바이스가-오프라인일-때" tabindex="-1"><a class="header-anchor" href="#디바이스가-오프라인일-때"><span>디바이스가 오프라인일 때</span></a></h3><ul><li>사용자가 앱에서 &quot;전구 켜줘&quot;라고 명령</li><li>하지만 전구가 인터넷 연결이 끊어진 상태</li><li>Shadow에 <code>&quot;desired&quot;: {&quot;power&quot;: &quot;on&quot;}</code>을 저장</li><li>전구가 다시 온라인 되면 Shadow를 확인하고 상태를 동기화</li></ul><h3 id="여러-앱에서-동시에-접근할-때" tabindex="-1"><a class="header-anchor" href="#여러-앱에서-동시에-접근할-때"><span>여러 앱에서 동시에 접근할 때</span></a></h3><ul><li>가족 구성원들이 각자의 스마트폰으로 같은 IoT 기기 제어</li><li>Shadow가 중앙 상태 저장소 역할</li><li>누가 어디서 바꿔도 모든 앱이 동일한 상태 확인 가능</li></ul><h2 id="shadow의-구조" tabindex="-1"><a class="header-anchor" href="#shadow의-구조"><span>Shadow의 구조</span></a></h2><p>Shadow는 크게 3가지 상태로 구성된다:</p><table><thead><tr><th>필드</th><th>설명</th><th>예시</th></tr></thead><tbody><tr><td><code>desired</code></td><td>사용자가 원하는 상태</td><td>앱에서 &quot;밝기를 70%로&quot; 설정</td></tr><tr><td><code>reported</code></td><td>디바이스가 실제 보고한 상태</td><td>전구에서 &quot;현재 밝기 70%&quot; 보고</td></tr><tr><td><code>delta</code></td><td>차이값 (AWS가 자동 생성)</td><td>desired ≠ reported일 때만 존재</td></tr></tbody></table><h3 id="동기화-과정" tabindex="-1"><a class="header-anchor" href="#동기화-과정"><span>동기화 과정</span></a></h3><ol><li>사용자 앱이 <code>&quot;power&quot;: &quot;on&quot;</code> → Shadow의 <code>desired</code> 업데이트</li><li>Shadow는 <code>delta</code> 자동 생성 (<code>&quot;power&quot;: &quot;on&quot;</code>)</li><li>디바이스가 <code>delta</code> MQTT 메시지를 구독하고 상태 변경</li><li>디바이스가 실제로 켜지면 <code>reported</code>에 <code>&quot;power&quot;: &quot;on&quot;</code> 업데이트</li><li><code>desired</code>와 <code>reported</code>가 같아지면 <code>delta</code> 자동 제거</li></ol><h2 id="named-shadow-vs-unnamed-shadow" tabindex="-1"><a class="header-anchor" href="#named-shadow-vs-unnamed-shadow"><span>Named Shadow vs Unnamed Shadow</span></a></h2><p>처음 AWS IoT를 사용할 때는 기본 Shadow(Unnamed)만 사용했는데, 복잡한 디바이스를 다루다 보니 Named Shadow의 필요성을 느꼈다.</p><table><thead><tr><th>구분</th><th>Unnamed Shadow</th><th>Named Shadow</th></tr></thead><tbody><tr><td>개수</td><td>디바이스당 1개</td><td>디바이스당 여러 개 가능</td></tr><tr><td>용도</td><td>간단한 상태 관리</td><td>복합적인 상태 분리 관리</td></tr><tr><td>예시</td><td>전체 전원 상태</td><td><code>temp-sensor</code>, <code>fan-config</code>, <code>security-mode</code> 등</td></tr></tbody></table><p>예를 들어, 스마트 에어컨의 경우:</p><ul><li><code>temp-control</code>: 온도 관련 설정</li><li><code>fan-speed</code>: 풍속 관련 설정</li><li><code>timer-config</code>: 타이머 관련 설정</li></ul><p>이렇게 기능별로 Shadow를 분리하면 각 기능의 상태를 독립적으로 관리할 수 있어 훨씬 깔끔하다.</p><hr><h1 id="_2-인증서와-보안-iot-디바이스의-신원-증명" tabindex="-1"><a class="header-anchor" href="#_2-인증서와-보안-iot-디바이스의-신원-증명"><span>2. 인증서와 보안: IoT 디바이스의 신원 증명</span></a></h1><h2 id="필수-인증서-파일들" tabindex="-1"><a class="header-anchor" href="#필수-인증서-파일들"><span>필수 인증서 파일들</span></a></h2><p>AWS IoT에 디바이스를 연결하려면 3개의 파일이 반드시 필요하다:</p><p><img src="`+v+`" alt="image-20250627110412819"></p><h3 id="_1-certificate-pem-crt-클라이언트-인증서" tabindex="-1"><a class="header-anchor" href="#_1-certificate-pem-crt-클라이언트-인증서"><span>1. <code>certificate.pem.crt</code> (클라이언트 인증서)</span></a></h3><ul><li>디바이스의 신원을 증명하는 X.509 인증서</li><li>&quot;이 디바이스가 정말 우리가 등록한 디바이스가 맞나요?&quot;를 확인</li></ul><h3 id="_2-private-key-pem-개인-키" tabindex="-1"><a class="header-anchor" href="#_2-private-key-pem-개인-키"><span>2. <code>private-key.pem</code> (개인 키)</span></a></h3><ul><li>인증서와 쌍을 이루는 비밀키</li><li><strong>절대 유출되면 안 되는 파일</strong> (이 키가 탈취되면 디바이스 권한 탈취됨)</li></ul><h3 id="_3-rootca1-pem-루트-인증서" tabindex="-1"><a class="header-anchor" href="#_3-rootca1-pem-루트-인증서"><span>3. <code>rootCA1.pem</code> (루트 인증서)</span></a></h3><ul><li>AWS IoT Core 서버의 신원을 검증하는 용도</li><li>&quot;내가 연결하려는 서버가 정말 AWS 서버가 맞나요?&quot;를 확인</li></ul><h2 id="tls-mutual-authentication-과정" tabindex="-1"><a class="header-anchor" href="#tls-mutual-authentication-과정"><span>TLS Mutual Authentication 과정</span></a></h2><p>디바이스와 AWS IoT Core 간의 연결은 양방향 인증으로 이루어진다:</p><h3 id="_1단계-서버-인증-디바이스-→-aws-검증" tabindex="-1"><a class="header-anchor" href="#_1단계-서버-인증-디바이스-→-aws-검증"><span>1단계: 서버 인증 (디바이스 → AWS 검증)</span></a></h3><ul><li>AWS가 자신의 서버 인증서를 디바이스에 전송</li><li>디바이스가 <code>rootCA1.pem</code>으로 AWS 서버 신원 검증</li><li>&quot;연결하려는 서버가 진짜 AWS가 맞나?&quot; 확인</li></ul><h3 id="_2단계-클라이언트-인증-aws-→-디바이스-검증" tabindex="-1"><a class="header-anchor" href="#_2단계-클라이언트-인증-aws-→-디바이스-검증"><span>2단계: 클라이언트 인증 (AWS → 디바이스 검증)</span></a></h3><ul><li>디바이스가 <code>certificate.pem.crt</code>를 AWS에 전송</li><li>AWS가 등록된 인증서인지 확인하고 연결된 정책 검사</li><li>&quot;이 디바이스가 연결할 권한이 있나?&quot; 확인</li></ul><h3 id="_3단계-tls-세션-성립" tabindex="-1"><a class="header-anchor" href="#_3단계-tls-세션-성립"><span>3단계: TLS 세션 성립</span></a></h3><ul><li>양방향 인증 완료 후 암호화된 MQTT 통신 시작</li></ul><p>실제 Python 코드에서는 이렇게 설정한다:</p><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py" data-title="py"><pre><code><span class="line">shadow_client<span class="token punctuation">.</span>configureCredentials<span class="token punctuation">(</span></span>
<span class="line">    root_ca_path<span class="token punctuation">,</span>      <span class="token comment"># AWS 서버 검증용</span></span>
<span class="line">    private_key_path<span class="token punctuation">,</span>  <span class="token comment"># 디바이스 서명용</span></span>
<span class="line">    cert_path         <span class="token comment"># 디바이스 신원 증명용</span></span>
<span class="line"><span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><hr><h1 id="_3-실제-python-코드로-보는-shadow-활용" tabindex="-1"><a class="header-anchor" href="#_3-실제-python-코드로-보는-shadow-활용"><span>3. 실제 Python 코드로 보는 Shadow 활용</span></a></h1><p>실무에서 사용한 코드를 기반으로 Shadow 활용법을 살펴보자.</p><h2 id="기본-연결-설정" tabindex="-1"><a class="header-anchor" href="#기본-연결-설정"><span>기본 연결 설정</span></a></h2><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py" data-title="py"><pre><code><span class="line"><span class="token keyword">import</span> json</span>
<span class="line"><span class="token keyword">import</span> time</span>
<span class="line"><span class="token keyword">from</span> AWSIoTPythonSDK<span class="token punctuation">.</span>MQTTLib <span class="token keyword">import</span> AWSIoTMQTTShadowClient</span>
<span class="line"></span>
<span class="line"><span class="token comment"># AWS IoT 설정</span></span>
<span class="line">ENDPOINT <span class="token operator">=</span> <span class="token string">&quot;your-endpoint.iot.ap-northeast-2.amazonaws.com&quot;</span></span>
<span class="line">CLIENT_ID <span class="token operator">=</span> <span class="token string">&quot;my_device&quot;</span></span>
<span class="line">THING_NAME <span class="token operator">=</span> <span class="token string">&quot;my_device&quot;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># 인증서 파일 경로</span></span>
<span class="line">CERT_PATH <span class="token operator">=</span> <span class="token string">&quot;certificate.pem.crt&quot;</span></span>
<span class="line">PRIVATE_KEY_PATH <span class="token operator">=</span> <span class="token string">&quot;private.pem.key&quot;</span></span>
<span class="line">ROOT_CA_PATH <span class="token operator">=</span> <span class="token string">&quot;AmazonRootCA1.pem&quot;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="shadow-콜백-함수들" tabindex="-1"><a class="header-anchor" href="#shadow-콜백-함수들"><span>Shadow 콜백 함수들</span></a></h2><h3 id="delta-콜백-원격-제어-받기" tabindex="-1"><a class="header-anchor" href="#delta-콜백-원격-제어-받기"><span>Delta 콜백: 원격 제어 받기</span></a></h3><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py" data-title="py"><pre><code><span class="line"><span class="token keyword">def</span> <span class="token function">shadow_callback_delta</span><span class="token punctuation">(</span>payload<span class="token punctuation">,</span> responseStatus<span class="token punctuation">,</span> token<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token triple-quoted-string string">&quot;&quot;&quot;desired 상태가 변경될 때 호출&quot;&quot;&quot;</span></span>
<span class="line">    payload_dict <span class="token operator">=</span> json<span class="token punctuation">.</span>loads<span class="token punctuation">(</span>payload<span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">if</span> <span class="token string">&quot;state&quot;</span> <span class="token keyword">in</span> payload_dict <span class="token keyword">and</span> <span class="token string">&quot;power&quot;</span> <span class="token keyword">in</span> payload_dict<span class="token punctuation">[</span><span class="token string">&quot;state&quot;</span><span class="token punctuation">]</span><span class="token punctuation">:</span></span>
<span class="line">        desired_power <span class="token operator">=</span> payload_dict<span class="token punctuation">[</span><span class="token string">&quot;state&quot;</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">&quot;power&quot;</span><span class="token punctuation">]</span></span>
<span class="line">        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f&quot;원격 명령 수신: power = </span><span class="token interpolation"><span class="token punctuation">{</span>desired_power<span class="token punctuation">}</span></span><span class="token string">&quot;</span></span><span class="token punctuation">)</span></span>
<span class="line">        </span>
<span class="line">        <span class="token comment"># 실제 디바이스 상태 변경</span></span>
<span class="line">        DEVICE_STATE<span class="token punctuation">[</span><span class="token string">&quot;power&quot;</span><span class="token punctuation">]</span> <span class="token operator">=</span> desired_power</span>
<span class="line">        </span>
<span class="line">        <span class="token comment"># 특별한 동작 수행</span></span>
<span class="line">        <span class="token keyword">if</span> desired_power <span class="token operator">==</span> <span class="token string">&quot;꺼짐&quot;</span><span class="token punctuation">:</span></span>
<span class="line">            shutdown_device<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="update-콜백-상태-업데이트-결과-확인" tabindex="-1"><a class="header-anchor" href="#update-콜백-상태-업데이트-결과-확인"><span>Update 콜백: 상태 업데이트 결과 확인</span></a></h3><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py" data-title="py"><pre><code><span class="line"><span class="token keyword">def</span> <span class="token function">shadow_callback_update</span><span class="token punctuation">(</span>payload<span class="token punctuation">,</span> responseStatus<span class="token punctuation">,</span> token<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token triple-quoted-string string">&quot;&quot;&quot;Shadow 업데이트 결과 처리&quot;&quot;&quot;</span></span>
<span class="line">    <span class="token keyword">if</span> responseStatus <span class="token operator">==</span> <span class="token string">&quot;accepted&quot;</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;Shadow 업데이트 성공&quot;</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">else</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f&quot;Shadow 업데이트 실패: </span><span class="token interpolation"><span class="token punctuation">{</span>responseStatus<span class="token punctuation">}</span></span><span class="token string">&quot;</span></span><span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="실무-팁" tabindex="-1"><a class="header-anchor" href="#실무-팁"><span>실무 팁</span></a></h2><h3 id="연결-안정성-향상" tabindex="-1"><a class="header-anchor" href="#연결-안정성-향상"><span>연결 안정성 향상</span></a></h3><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py" data-title="py"><pre><code><span class="line"><span class="token comment"># 타임아웃 값을 여유있게 설정</span></span>
<span class="line">shadow_client<span class="token punctuation">.</span>configureConnectDisconnectTimeout<span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span>  <span class="token comment"># 기본 10초 → 20초</span></span>
<span class="line">shadow_client<span class="token punctuation">.</span>configureMQTTOperationTimeout<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span>      <span class="token comment"># 기본 5초 → 10초</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># 자동 재연결 설정</span></span>
<span class="line">shadow_client<span class="token punctuation">.</span>configureAutoReconnectBackoffTime<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="에러-처리" tabindex="-1"><a class="header-anchor" href="#에러-처리"><span>에러 처리</span></a></h3><p>실제 운영에서는 네트워크 문제로 인한 연결 실패가 빈번하다. 반드시 예외 처리를 해주자:</p><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py" data-title="py"><pre><code><span class="line"><span class="token keyword">try</span><span class="token punctuation">:</span></span>
<span class="line">    shadow_client<span class="token punctuation">.</span>connect<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;AWS IoT 연결 성공&quot;</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span></span>
<span class="line">    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f&quot;연결 실패: </span><span class="token interpolation"><span class="token punctuation">{</span>e<span class="token punctuation">}</span></span><span class="token string">&quot;</span></span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token comment"># 재시도 로직 또는 로그 기록</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><hr><h1 id="_4-job-대규모-디바이스-관리의-핵심" tabindex="-1"><a class="header-anchor" href="#_4-job-대규모-디바이스-관리의-핵심"><span>4. Job: 대규모 디바이스 관리의 핵심</span></a></h1><h2 id="job이-필요한-이유" tabindex="-1"><a class="header-anchor" href="#job이-필요한-이유"><span>Job이 필요한 이유</span></a></h2><p>Shadow는 상태 관리에 특화되어 있지만, 다음과 같은 상황에서는 한계가 있다:</p><ul><li><strong>펌웨어 업데이트</strong>: 수백 대의 디바이스에 동시에 새 펌웨어 배포</li><li><strong>설정 변경</strong>: 특정 그룹의 디바이스들에게 일괄 설정 변경 명령</li><li><strong>진행 상황 추적</strong>: 작업이 성공했는지, 실패했는지, 어디서 멈췄는지 관리</li></ul><p>이런 <strong>명령 중심의 작업</strong>에는 Job을 사용한다.</p><h2 id="shadow-vs-job-비교" tabindex="-1"><a class="header-anchor" href="#shadow-vs-job-비교"><span>Shadow vs Job 비교</span></a></h2><table><thead><tr><th>구분</th><th>Shadow</th><th>Job</th></tr></thead><tbody><tr><td>목적</td><td>상태 동기화</td><td>명령 실행</td></tr><tr><td>방식</td><td>&quot;이 상태가 되어야 해&quot;</td><td>&quot;이 작업을 해줘&quot;</td></tr><tr><td>대상</td><td>개별 디바이스</td><td>개별 또는 그룹</td></tr><tr><td>예시</td><td>&quot;전원을 켜진 상태로 유지&quot;</td><td>&quot;펌웨어를 v2.0으로 업데이트&quot;</td></tr><tr><td>상태 추적</td><td>desired/reported</td><td>IN_PROGRESS/SUCCEEDED/FAILED</td></tr></tbody></table><h2 id="job-document-구조" tabindex="-1"><a class="header-anchor" href="#job-document-구조"><span>Job Document 구조</span></a></h2><p>Job Document는 자유로운 JSON 형식이다. 실무에서는 다음과 같은 구조를 많이 사용한다:</p><h3 id="예시-1-펌웨어-업데이트" tabindex="-1"><a class="header-anchor" href="#예시-1-펌웨어-업데이트"><span>예시 1: 펌웨어 업데이트</span></a></h3><div class="language-json line-numbers-mode" data-highlighter="prismjs" data-ext="json" data-title="json"><pre><code><span class="line"><span class="token punctuation">{</span></span>
<span class="line">  <span class="token property">&quot;operation&quot;</span><span class="token operator">:</span> <span class="token string">&quot;update-firmware&quot;</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token property">&quot;url&quot;</span><span class="token operator">:</span> <span class="token string">&quot;https://my-bucket.s3.amazonaws.com/firmware-v2.0.bin&quot;</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token property">&quot;version&quot;</span><span class="token operator">:</span> <span class="token string">&quot;2.0&quot;</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token property">&quot;checksum&quot;</span><span class="token operator">:</span> <span class="token string">&quot;sha256:abc123...&quot;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="예시-2-설정-변경" tabindex="-1"><a class="header-anchor" href="#예시-2-설정-변경"><span>예시 2: 설정 변경</span></a></h3><div class="language-json line-numbers-mode" data-highlighter="prismjs" data-ext="json" data-title="json"><pre><code><span class="line"><span class="token punctuation">{</span></span>
<span class="line">  <span class="token property">&quot;operation&quot;</span><span class="token operator">:</span> <span class="token string">&quot;update-config&quot;</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token property">&quot;config&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token property">&quot;logLevel&quot;</span><span class="token operator">:</span> <span class="token string">&quot;DEBUG&quot;</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token property">&quot;reportInterval&quot;</span><span class="token operator">:</span> <span class="token number">30</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token property">&quot;sensors&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;temperature&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;humidity&quot;</span><span class="token punctuation">]</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="예시-3-단순-명령" tabindex="-1"><a class="header-anchor" href="#예시-3-단순-명령"><span>예시 3: 단순 명령</span></a></h3><div class="language-json line-numbers-mode" data-highlighter="prismjs" data-ext="json" data-title="json"><pre><code><span class="line"><span class="token punctuation">{</span></span>
<span class="line">  <span class="token property">&quot;operation&quot;</span><span class="token operator">:</span> <span class="token string">&quot;reboot&quot;</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token property">&quot;delay&quot;</span><span class="token operator">:</span> <span class="token number">60</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="job-생성-및-관리" tabindex="-1"><a class="header-anchor" href="#job-생성-및-관리"><span>Job 생성 및 관리</span></a></h2><h3 id="cli로-job-생성" tabindex="-1"><a class="header-anchor" href="#cli로-job-생성"><span>CLI로 Job 생성</span></a></h3><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line">aws iot create-job <span class="token punctuation">\\</span></span>
<span class="line">  --job-id firmware-update-2024 <span class="token punctuation">\\</span></span>
<span class="line">  <span class="token parameter variable">--targets</span> <span class="token string">&quot;arn:aws:iot:ap-northeast-2:123456789012:thinggroup/ProductionDevices&quot;</span> <span class="token punctuation">\\</span></span>
<span class="line">  <span class="token parameter variable">--document</span> file://firmware-job.json <span class="token punctuation">\\</span></span>
<span class="line">  --timeout-config <span class="token assign-left variable">inProgressTimeoutInMinutes</span><span class="token operator">=</span><span class="token number">30</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="디바이스에서-job-처리" tabindex="-1"><a class="header-anchor" href="#디바이스에서-job-처리"><span>디바이스에서 Job 처리</span></a></h3><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py" data-title="py"><pre><code><span class="line"><span class="token keyword">def</span> <span class="token function">process_job</span><span class="token punctuation">(</span>job_document<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token triple-quoted-string string">&quot;&quot;&quot;Job 문서를 파싱하고 작업 수행&quot;&quot;&quot;</span></span>
<span class="line">    operation <span class="token operator">=</span> job_document<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">&quot;operation&quot;</span><span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">if</span> operation <span class="token operator">==</span> <span class="token string">&quot;update-firmware&quot;</span><span class="token punctuation">:</span></span>
<span class="line">        url <span class="token operator">=</span> job_document<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">&quot;url&quot;</span><span class="token punctuation">)</span></span>
<span class="line">        version <span class="token operator">=</span> job_document<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">&quot;version&quot;</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">return</span> download_and_install_firmware<span class="token punctuation">(</span>url<span class="token punctuation">,</span> version<span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">elif</span> operation <span class="token operator">==</span> <span class="token string">&quot;update-config&quot;</span><span class="token punctuation">:</span></span>
<span class="line">        config <span class="token operator">=</span> job_document<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">&quot;config&quot;</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">return</span> update_device_config<span class="token punctuation">(</span>config<span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">elif</span> operation <span class="token operator">==</span> <span class="token string">&quot;reboot&quot;</span><span class="token punctuation">:</span></span>
<span class="line">        delay <span class="token operator">=</span> job_document<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">&quot;delay&quot;</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">return</span> schedule_reboot<span class="token punctuation">(</span>delay<span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">else</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token punctuation">{</span><span class="token string">&quot;status&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;FAILED&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;reason&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;Unknown operation&quot;</span><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><hr><h1 id="_5-실무에서-배운-교훈들" tabindex="-1"><a class="header-anchor" href="#_5-실무에서-배운-교훈들"><span>5. 실무에서 배운 교훈들</span></a></h1><h2 id="디바이스-오프라인-대응" tabindex="-1"><a class="header-anchor" href="#디바이스-오프라인-대응"><span>디바이스 오프라인 대응</span></a></h2><p>실제 IoT 환경에서는 디바이스가 예상보다 자주 오프라인이 된다. 특히 모바일 환경이나 Wi-Fi가 불안정한 곳에서는 더욱 그렇다. Shadow의 진가는 이런 상황에서 발휘된다.</p><ul><li><strong>Before Shadow</strong>: 명령이 실패하면 사용자가 다시 시도해야 함</li><li><strong>After Shadow</strong>: 디바이스가 다시 온라인 되면 자동으로 상태 동기화</li></ul><h2 id="대규모-배포시-주의사항" tabindex="-1"><a class="header-anchor" href="#대규모-배포시-주의사항"><span>대규모 배포시 주의사항</span></a></h2><p>수백 대의 디바이스에 동시에 Job을 배포할 때는 반드시 **점진적 배포(Rollout)**를 사용하자:</p><div class="language-json line-numbers-mode" data-highlighter="prismjs" data-ext="json" data-title="json"><pre><code><span class="line"><span class="token punctuation">{</span></span>
<span class="line">  <span class="token property">&quot;jobExecutionsRolloutConfig&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token property">&quot;maximumPerMinute&quot;</span><span class="token operator">:</span> <span class="token number">50</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token property">&quot;exponentialRate&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token property">&quot;baseRatePerMinute&quot;</span><span class="token operator">:</span> <span class="token number">10</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token property">&quot;incrementFactor&quot;</span><span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token property">&quot;rateIncreaseCriteria&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token property">&quot;numberOfSucceededThings&quot;</span><span class="token operator">:</span> <span class="token number">10</span></span>
<span class="line">      <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>처음에 이걸 안 하고 전체 디바이스에 동시 배포했다가 AWS IoT Core 할당량에 걸려서 곤란했던 경험이 있다.</p><h2 id="보안-관련-팁" tabindex="-1"><a class="header-anchor" href="#보안-관련-팁"><span>보안 관련 팁</span></a></h2><h3 id="_1-인증서-로테이션" tabindex="-1"><a class="header-anchor" href="#_1-인증서-로테이션"><span>1. 인증서 로테이션</span></a></h3><ul><li>프로덕션 환경에서는 주기적으로 인증서를 갱신하자</li><li>AWS IoT Core에서 인증서 만료일 알림 설정 가능</li></ul><h3 id="_2-정책-최소권한-원칙" tabindex="-1"><a class="header-anchor" href="#_2-정책-최소권한-원칙"><span>2. 정책 최소권한 원칙</span></a></h3><div class="language-json line-numbers-mode" data-highlighter="prismjs" data-ext="json" data-title="json"><pre><code><span class="line"><span class="token punctuation">{</span></span>
<span class="line">  <span class="token property">&quot;Version&quot;</span><span class="token operator">:</span> <span class="token string">&quot;2012-10-17&quot;</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token property">&quot;Statement&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span></span>
<span class="line">    <span class="token punctuation">{</span></span>
<span class="line">      <span class="token property">&quot;Effect&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Allow&quot;</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token property">&quot;Action&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span></span>
<span class="line">        <span class="token string">&quot;iot:Connect&quot;</span></span>
<span class="line">      <span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token property">&quot;Resource&quot;</span><span class="token operator">:</span> <span class="token string">&quot;arn:aws:iot:region:account:client/\${iot:Connection.Thing.ThingName}&quot;</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token punctuation">{</span></span>
<span class="line">      <span class="token property">&quot;Effect&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Allow&quot;</span><span class="token punctuation">,</span> </span>
<span class="line">      <span class="token property">&quot;Action&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span></span>
<span class="line">        <span class="token string">&quot;iot:GetThingShadow&quot;</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token string">&quot;iot:UpdateThingShadow&quot;</span></span>
<span class="line">      <span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token property">&quot;Resource&quot;</span><span class="token operator">:</span> <span class="token string">&quot;arn:aws:iot:region:account:thing/\${iot:Connection.Thing.ThingName}/shadow&quot;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">  <span class="token punctuation">]</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>필요한 권한만 최소한으로 부여하는 것이 중요하다.</p><hr><h1 id="_6-메시지-크기-최적화-비용-절약의-핵심" tabindex="-1"><a class="header-anchor" href="#_6-메시지-크기-최적화-비용-절약의-핵심"><span>6. 메시지 크기 최적화: 비용 절약의 핵심</span></a></h1><h2 id="aws-iot-core-실제-과금-방식" tabindex="-1"><a class="header-anchor" href="#aws-iot-core-실제-과금-방식"><span>AWS IoT Core 실제 과금 방식</span></a></h2><p>처음 AWS IoT Core를 사용할 때 메시지 크기에 대해 잘못 이해하고 있었다. 공식 문서에는 &quot;최대 128KB 메시지 지원&quot;이라고 나와 있지만, 실제 과금은 <strong>5KB 단위</strong>로 이루어진다.</p><h3 id="실제-과금-구조" tabindex="-1"><a class="header-anchor" href="#실제-과금-구조"><span>실제 과금 구조</span></a></h3><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">- 0~5KB: 1 메시지 요금</span>
<span class="line">- 5KB~10KB: 2 메시지 요금  </span>
<span class="line">- 10KB~15KB: 3 메시지 요금</span>
<span class="line">- ...</span>
<span class="line">- 125KB~128KB: 26 메시지 요금 (최대)</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>이때문에 5.1KB 메시지 하나는 4.9KB 메시지보다 <strong>2배</strong>의 비용이 든다.</p><h2 id="실제-비용-영향-사례" tabindex="-1"><a class="header-anchor" href="#실제-비용-영향-사례"><span>실제 비용 영향 사례</span></a></h2><p>아례는 예시이다.</p><h3 id="before-최적화-8kb-센서-데이터" tabindex="-1"><a class="header-anchor" href="#before-최적화-8kb-센서-데이터"><span>Before 최적화 (8KB 센서 데이터)</span></a></h3><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py" data-title="py"><pre><code><span class="line"><span class="token comment"># 최적화 전: 8KB 메시지</span></span>
<span class="line">message <span class="token operator">=</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token string">&quot;deviceIdentifier&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;sensor-temperature-basement-001&quot;</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token string">&quot;measurementTimestamp&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;2025-06-27T10:30:00.000Z&quot;</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token string">&quot;temperatureReadings&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">23.1</span><span class="token punctuation">,</span> <span class="token number">23.2</span><span class="token punctuation">,</span> <span class="token number">23.1</span><span class="token punctuation">,</span> <span class="token number">23.0</span><span class="token punctuation">,</span> <span class="token number">23.2</span><span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span><span class="token punctuation">,</span>  <span class="token comment"># 1000개 데이터</span></span>
<span class="line">    <span class="token string">&quot;humidityReadings&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">65.2</span><span class="token punctuation">,</span> <span class="token number">65.1</span><span class="token punctuation">,</span> <span class="token number">65.3</span><span class="token punctuation">,</span> <span class="token number">65.0</span><span class="token punctuation">,</span> <span class="token number">65.4</span><span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span><span class="token punctuation">,</span>     <span class="token comment"># 1000개 데이터</span></span>
<span class="line">    <span class="token string">&quot;deviceMetadata&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token string">&quot;firmwareVersion&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;v2.1.0&quot;</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token string">&quot;batteryLevel&quot;</span><span class="token punctuation">:</span> <span class="token number">85</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token string">&quot;signalStrength&quot;</span><span class="token punctuation">:</span> <span class="token operator">-</span><span class="token number">45</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"><span class="token comment"># 크기: 8KB → 2 메시지 요금 부과</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="after-최적화-4-2kb-압축-데이터" tabindex="-1"><a class="header-anchor" href="#after-최적화-4-2kb-압축-데이터"><span>After 최적화 (4.2KB 압축 데이터)</span></a></h3><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py" data-title="py"><pre><code><span class="line"><span class="token comment"># 최적화 후: 4.2KB 메시지</span></span>
<span class="line">message <span class="token operator">=</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token string">&quot;id&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;st_b001&quot;</span><span class="token punctuation">,</span>  <span class="token comment"># deviceIdentifier 축약</span></span>
<span class="line">    <span class="token string">&quot;ts&quot;</span><span class="token punctuation">:</span> <span class="token number">1719485400</span><span class="token punctuation">,</span>  <span class="token comment"># unix timestamp 사용</span></span>
<span class="line">    <span class="token string">&quot;temp&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;23.1,23.2,23.1,23.0,23.2,...&quot;</span><span class="token punctuation">,</span>  <span class="token comment"># 배열을 문자열로 압축</span></span>
<span class="line">    <span class="token string">&quot;hum&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;65.2,65.1,65.3,65.0,65.4,...&quot;</span><span class="token punctuation">,</span>   <span class="token comment"># 배열을 문자열로 압축</span></span>
<span class="line">    <span class="token string">&quot;meta&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token string">&quot;fw&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;v2.1.0&quot;</span><span class="token punctuation">,</span>  <span class="token comment"># 키 이름 축약</span></span>
<span class="line">        <span class="token string">&quot;bat&quot;</span><span class="token punctuation">:</span> <span class="token number">85</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token string">&quot;sig&quot;</span><span class="token punctuation">:</span> <span class="token operator">-</span><span class="token number">45</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"><span class="token comment"># 크기: 4.2KB → 1 메시지 요금만 부과</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>결과: 메시지당 비용이 50% 절약!</strong></p><h2 id="월별-비용-차이-계산" tabindex="-1"><a class="header-anchor" href="#월별-비용-차이-계산"><span>월별 비용 차이 계산</span></a></h2><p>월 100만 메시지를 전송하는 디바이스 100대 기준,</p><h3 id="_8kb-메시지-최적화-전" tabindex="-1"><a class="header-anchor" href="#_8kb-메시지-최적화-전"><span>8KB 메시지 (최적화 전)</span></a></h3><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">- 월 메시지: 100만 × 100대 = 1억 메시지</span>
<span class="line">- 과금 메시지: 2억 메시지 (5KB 초과로 2배 계산)</span>
<span class="line">- 월 비용: 2억 × $1.20/1백만 = $240</span>
<span class="line">- 연간 비용: $240 × 12 = $2,880</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_4-2kb-메시지-최적화-후" tabindex="-1"><a class="header-anchor" href="#_4-2kb-메시지-최적화-후"><span>4.2KB 메시지 (최적화 후)</span></a></h3><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">- 월 메시지: 100만 × 100대 = 1억 메시지  </span>
<span class="line">- 과금 메시지: 1억 메시지 (5KB 이하로 1배 계산)</span>
<span class="line">- 월 비용: 1억 × $1.20/1백만 = $120</span>
<span class="line">- 연간 비용: $120 × 12 = $1,440</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>연간 절약액: $1,440 (50% 절약)</strong></p><h2 id="실무-최적화-기법들" tabindex="-1"><a class="header-anchor" href="#실무-최적화-기법들"><span>실무 최적화 기법들</span></a></h2><h3 id="_1-json-키-이름-축약" tabindex="-1"><a class="header-anchor" href="#_1-json-키-이름-축약"><span>1. JSON 키 이름 축약</span></a></h3><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py" data-title="py"><pre><code><span class="line"><span class="token comment"># Before: 장황한 키 이름 (가독성 좋지만 비효율)</span></span>
<span class="line"><span class="token punctuation">{</span></span>
<span class="line">    <span class="token string">&quot;deviceIdentifier&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;sensor-001&quot;</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token string">&quot;measurementTimestamp&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;2025-06-27T10:30:00Z&quot;</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token string">&quot;temperatureReading&quot;</span><span class="token punctuation">:</span> <span class="token number">23.45</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token string">&quot;humidityPercentage&quot;</span><span class="token punctuation">:</span> <span class="token number">65.2</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token string">&quot;batteryVoltageLevel&quot;</span><span class="token punctuation">:</span> <span class="token number">3.7</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># After: 축약된 키 이름 (크기 약 40% 절약)</span></span>
<span class="line"><span class="token punctuation">{</span></span>
<span class="line">    <span class="token string">&quot;id&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;s001&quot;</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token string">&quot;ts&quot;</span><span class="token punctuation">:</span> <span class="token number">1719485400</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token string">&quot;temp&quot;</span><span class="token punctuation">:</span> <span class="token number">23.45</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token string">&quot;hum&quot;</span><span class="token punctuation">:</span> <span class="token number">65.2</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token string">&quot;bat&quot;</span><span class="token punctuation">:</span> <span class="token number">3.7</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-데이터-타입-최적화" tabindex="-1"><a class="header-anchor" href="#_2-데이터-타입-최적화"><span>2. 데이터 타입 최적화</span></a></h3><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py" data-title="py"><pre><code><span class="line"><span class="token comment"># Before: 문자열 타임스탬프 (29 bytes)</span></span>
<span class="line"><span class="token string">&quot;timestamp&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;2025-06-27T10:30:00.000Z&quot;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># After: Unix 타임스탬프 (10 bytes)</span></span>
<span class="line"><span class="token string">&quot;ts&quot;</span><span class="token punctuation">:</span> <span class="token number">1719485400</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_3-배열-데이터-압축" tabindex="-1"><a class="header-anchor" href="#_3-배열-데이터-압축"><span>3. 배열 데이터 압축</span></a></h3><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py" data-title="py"><pre><code><span class="line"><span class="token comment"># Before: JSON 배열 (크기 큼)</span></span>
<span class="line"><span class="token string">&quot;readings&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">23.1</span><span class="token punctuation">,</span> <span class="token number">23.2</span><span class="token punctuation">,</span> <span class="token number">23.0</span><span class="token punctuation">,</span> <span class="token number">23.1</span><span class="token punctuation">,</span> <span class="token number">23.2</span><span class="token punctuation">]</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># After: 문자열 압축 (크기 작음)</span></span>
<span class="line"><span class="token string">&quot;readings&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;23.1,23.2,23.0,23.1,23.2&quot;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_4-gzip-압축-활용" tabindex="-1"><a class="header-anchor" href="#_4-gzip-압축-활용"><span>4. GZIP 압축 활용</span></a></h3><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py" data-title="py"><pre><code><span class="line"><span class="token keyword">import</span> json</span>
<span class="line"><span class="token keyword">import</span> gzip</span>
<span class="line"><span class="token keyword">import</span> base64</span>
<span class="line"></span>
<span class="line"><span class="token keyword">def</span> <span class="token function">compress_message</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token triple-quoted-string string">&quot;&quot;&quot;메시지를 GZIP으로 압축&quot;&quot;&quot;</span></span>
<span class="line">    json_str <span class="token operator">=</span> json<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>data<span class="token punctuation">)</span></span>
<span class="line">    compressed <span class="token operator">=</span> gzip<span class="token punctuation">.</span>compress<span class="token punctuation">(</span>json_str<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">    encoded <span class="token operator">=</span> base64<span class="token punctuation">.</span>b64encode<span class="token punctuation">(</span>compressed<span class="token punctuation">)</span><span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">return</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token string">&quot;compressed&quot;</span><span class="token punctuation">:</span> <span class="token boolean">True</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token string">&quot;data&quot;</span><span class="token punctuation">:</span> encoded</span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># 실제 측정 결과:</span></span>
<span class="line"><span class="token comment"># Original: 8192 bytes (8KB)</span></span>
<span class="line"><span class="token comment"># Compressed: 2048 bytes (2KB) → 75% 절약!</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="메시지-크기-모니터링-도구" tabindex="-1"><a class="header-anchor" href="#메시지-크기-모니터링-도구"><span>메시지 크기 모니터링 도구</span></a></h2><p>실무에서 사용하는 메시지 크기 체크 함수</p><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py" data-title="py"><pre><code><span class="line"><span class="token keyword">import</span> json</span>
<span class="line"></span>
<span class="line"><span class="token keyword">def</span> <span class="token function">check_message_size</span><span class="token punctuation">(</span>message<span class="token punctuation">,</span> warn_threshold<span class="token operator">=</span><span class="token number">4.5</span><span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token triple-quoted-string string">&quot;&quot;&quot;메시지 크기를 체크하고 경고&quot;&quot;&quot;</span></span>
<span class="line">    json_str <span class="token operator">=</span> json<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>message<span class="token punctuation">)</span></span>
<span class="line">    size_kb <span class="token operator">=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>json_str<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">1024</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">if</span> size_kb <span class="token operator">&gt;</span> <span class="token number">5.0</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f&quot;🚨 CRITICAL: </span><span class="token interpolation"><span class="token punctuation">{</span>size_kb<span class="token punctuation">:</span><span class="token format-spec">.2f</span><span class="token punctuation">}</span></span><span class="token string">KB - 2배 요금 부과!&quot;</span></span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token boolean">False</span></span>
<span class="line">    <span class="token keyword">elif</span> size_kb <span class="token operator">&gt;</span> warn_threshold<span class="token punctuation">:</span></span>
<span class="line">        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f&quot;⚠️ WARNING: </span><span class="token interpolation"><span class="token punctuation">{</span>size_kb<span class="token punctuation">:</span><span class="token format-spec">.2f</span><span class="token punctuation">}</span></span><span class="token string">KB - 최적화 권장&quot;</span></span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token boolean">True</span></span>
<span class="line">    <span class="token keyword">else</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f&quot;✅ GOOD: </span><span class="token interpolation"><span class="token punctuation">{</span>size_kb<span class="token punctuation">:</span><span class="token format-spec">.2f</span><span class="token punctuation">}</span></span><span class="token string">KB - 최적화됨&quot;</span></span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token boolean">True</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># 사용 예시</span></span>
<span class="line">message <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">&quot;id&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;sensor001&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;data&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;...&quot;</span><span class="token punctuation">}</span></span>
<span class="line"><span class="token keyword">if</span> <span class="token keyword">not</span> check_message_size<span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">    message <span class="token operator">=</span> optimize_message<span class="token punctuation">(</span>message<span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="배치-전송으로-효율성-극대화" tabindex="-1"><a class="header-anchor" href="#배치-전송으로-효율성-극대화"><span>배치 전송으로 효율성 극대화</span></a></h2><p>개별 메시지 대신 배치로 전송하면 더욱 효율적이다.</p><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py" data-title="py"><pre><code><span class="line"><span class="token keyword">def</span> <span class="token function">batch_messages</span><span class="token punctuation">(</span>sensor_readings<span class="token punctuation">,</span> max_size_kb<span class="token operator">=</span><span class="token number">4.5</span><span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token triple-quoted-string string">&quot;&quot;&quot;메시지들을 4.5KB 이하 배치로 묶어서 전송&quot;&quot;&quot;</span></span>
<span class="line">    batch <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span></span>
<span class="line">    current_size <span class="token operator">=</span> <span class="token number">0</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">for</span> reading <span class="token keyword">in</span> sensor_readings<span class="token punctuation">:</span></span>
<span class="line">        <span class="token comment"># 메시지 크기 계산</span></span>
<span class="line">        test_batch <span class="token operator">=</span> batch <span class="token operator">+</span> <span class="token punctuation">[</span>reading<span class="token punctuation">]</span></span>
<span class="line">        test_size <span class="token operator">=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>json<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>test_batch<span class="token punctuation">)</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">1024</span></span>
<span class="line">        </span>
<span class="line">        <span class="token keyword">if</span> test_size <span class="token operator">&gt;</span> max_size_kb <span class="token keyword">and</span> batch<span class="token punctuation">:</span></span>
<span class="line">            <span class="token comment"># 현재 배치 전송</span></span>
<span class="line">            publish_message<span class="token punctuation">(</span>batch<span class="token punctuation">)</span></span>
<span class="line">            batch <span class="token operator">=</span> <span class="token punctuation">[</span>reading<span class="token punctuation">]</span></span>
<span class="line">        <span class="token keyword">else</span><span class="token punctuation">:</span></span>
<span class="line">            batch<span class="token punctuation">.</span>append<span class="token punctuation">(</span>reading<span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment"># 마지막 배치 전송</span></span>
<span class="line">    <span class="token keyword">if</span> batch<span class="token punctuation">:</span></span>
<span class="line">        publish_message<span class="token punctuation">(</span>batch<span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># Before: 100개 메시지 개별 전송 (1KB씩) = 100 메시지 요금</span></span>
<span class="line"><span class="token comment"># After: 4개 배치로 묶어서 전송 (4KB씩) = 25 메시지 요금 (75% 절약!)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="다른-aws-iot-서비스들도-마찬가지" tabindex="-1"><a class="header-anchor" href="#다른-aws-iot-서비스들도-마찬가지"><span>다른 AWS IoT 서비스들도 마찬가지</span></a></h2><p>이 5KB 규칙은 다른 AWS IoT 서비스에도 적용된다.</p><h3 id="device-shadow" tabindex="-1"><a class="header-anchor" href="#device-shadow"><span>Device Shadow</span></a></h3><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py" data-title="py"><pre><code><span class="line"><span class="token comment"># Shadow 업데이트도 5KB 초과시 2배 요금</span></span>
<span class="line">shadow_update <span class="token operator">=</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token string">&quot;state&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token string">&quot;desired&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token string">&quot;config&quot;</span><span class="token punctuation">:</span> very_large_config_data  <span class="token comment"># 5KB 초과 주의!</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="rules-engine" tabindex="-1"><a class="header-anchor" href="#rules-engine"><span>Rules Engine</span></a></h3><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py" data-title="py"><pre><code><span class="line"><span class="token comment"># Rule이 처리하는 메시지도 5KB 기준으로 계산</span></span>
<span class="line"><span class="token comment"># 8KB 메시지 → 2개 Rule 실행 요금 부과</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="핵심-권장사항" tabindex="-1"><a class="header-anchor" href="#핵심-권장사항"><span>핵심 권장사항</span></a></h2><ol><li><strong>4.8KB 이하 목표</strong>: 여유분을 고려해 4.8KB 이하로 메시지 크기 설정</li><li><strong>실시간 모니터링</strong>: 프로덕션에서 메시지 크기 모니터링 도구 사용</li><li><strong>압축 활용</strong>: GZIP, 키 축약, 타입 최적화 등 적극 활용</li><li><strong>배치 전송</strong>: 가능한 경우 여러 데이터를 배치로 묶어서 전송</li><li><strong>정기적 리뷰</strong>: 메시지 구조를 정기적으로 리뷰하고 최적화 �</li></ol>`,142)),a(o)])}const f=c(m,[["render",h],["__file","2025-06-27-iot.html.vue"]]),w=JSON.parse('{"path":"/posts/tech/2025-06-27-iot.html","title":"AWS IoT Core 완전 정복 - Shadow, 인증, Job까지","lang":"en-US","frontmatter":{"title":"AWS IoT Core 완전 정복 - Shadow, 인증, Job까지","date":"2025-06-27T00:00:00.000Z","tags":["aws","iot","mqtt","shadow"],"description":"AWS IoT Core의 핵심 개념들을 실무 예제와 함께 알아보자"},"headers":[{"level":1,"title":"1. Shadow: 디바이스 상태를 안전하게 관리하는 핵심 기능","slug":"_1-shadow-디바이스-상태를-안전하게-관리하는-핵심-기능","link":"#_1-shadow-디바이스-상태를-안전하게-관리하는-핵심-기능","children":[{"level":2,"title":"Shadow가 뭔가요?","slug":"shadow가-뭔가요","link":"#shadow가-뭔가요","children":[]},{"level":2,"title":"왜 필요한가?","slug":"왜-필요한가","link":"#왜-필요한가","children":[{"level":3,"title":"디바이스가 오프라인일 때","slug":"디바이스가-오프라인일-때","link":"#디바이스가-오프라인일-때","children":[]},{"level":3,"title":"여러 앱에서 동시에 접근할 때","slug":"여러-앱에서-동시에-접근할-때","link":"#여러-앱에서-동시에-접근할-때","children":[]}]},{"level":2,"title":"Shadow의 구조","slug":"shadow의-구조","link":"#shadow의-구조","children":[{"level":3,"title":"동기화 과정","slug":"동기화-과정","link":"#동기화-과정","children":[]}]},{"level":2,"title":"Named Shadow vs Unnamed Shadow","slug":"named-shadow-vs-unnamed-shadow","link":"#named-shadow-vs-unnamed-shadow","children":[]}]},{"level":1,"title":"2. 인증서와 보안: IoT 디바이스의 신원 증명","slug":"_2-인증서와-보안-iot-디바이스의-신원-증명","link":"#_2-인증서와-보안-iot-디바이스의-신원-증명","children":[{"level":2,"title":"필수 인증서 파일들","slug":"필수-인증서-파일들","link":"#필수-인증서-파일들","children":[{"level":3,"title":"1. certificate.pem.crt (클라이언트 인증서)","slug":"_1-certificate-pem-crt-클라이언트-인증서","link":"#_1-certificate-pem-crt-클라이언트-인증서","children":[]},{"level":3,"title":"2. private-key.pem (개인 키)","slug":"_2-private-key-pem-개인-키","link":"#_2-private-key-pem-개인-키","children":[]},{"level":3,"title":"3. rootCA1.pem (루트 인증서)","slug":"_3-rootca1-pem-루트-인증서","link":"#_3-rootca1-pem-루트-인증서","children":[]}]},{"level":2,"title":"TLS Mutual Authentication 과정","slug":"tls-mutual-authentication-과정","link":"#tls-mutual-authentication-과정","children":[{"level":3,"title":"1단계: 서버 인증 (디바이스 → AWS 검증)","slug":"_1단계-서버-인증-디바이스-→-aws-검증","link":"#_1단계-서버-인증-디바이스-→-aws-검증","children":[]},{"level":3,"title":"2단계: 클라이언트 인증 (AWS → 디바이스 검증)","slug":"_2단계-클라이언트-인증-aws-→-디바이스-검증","link":"#_2단계-클라이언트-인증-aws-→-디바이스-검증","children":[]},{"level":3,"title":"3단계: TLS 세션 성립","slug":"_3단계-tls-세션-성립","link":"#_3단계-tls-세션-성립","children":[]}]}]},{"level":1,"title":"3. 실제 Python 코드로 보는 Shadow 활용","slug":"_3-실제-python-코드로-보는-shadow-활용","link":"#_3-실제-python-코드로-보는-shadow-활용","children":[{"level":2,"title":"기본 연결 설정","slug":"기본-연결-설정","link":"#기본-연결-설정","children":[]},{"level":2,"title":"Shadow 콜백 함수들","slug":"shadow-콜백-함수들","link":"#shadow-콜백-함수들","children":[{"level":3,"title":"Delta 콜백: 원격 제어 받기","slug":"delta-콜백-원격-제어-받기","link":"#delta-콜백-원격-제어-받기","children":[]},{"level":3,"title":"Update 콜백: 상태 업데이트 결과 확인","slug":"update-콜백-상태-업데이트-결과-확인","link":"#update-콜백-상태-업데이트-결과-확인","children":[]}]},{"level":2,"title":"실무 팁","slug":"실무-팁","link":"#실무-팁","children":[{"level":3,"title":"연결 안정성 향상","slug":"연결-안정성-향상","link":"#연결-안정성-향상","children":[]},{"level":3,"title":"에러 처리","slug":"에러-처리","link":"#에러-처리","children":[]}]}]},{"level":1,"title":"4. Job: 대규모 디바이스 관리의 핵심","slug":"_4-job-대규모-디바이스-관리의-핵심","link":"#_4-job-대규모-디바이스-관리의-핵심","children":[{"level":2,"title":"Job이 필요한 이유","slug":"job이-필요한-이유","link":"#job이-필요한-이유","children":[]},{"level":2,"title":"Shadow vs Job 비교","slug":"shadow-vs-job-비교","link":"#shadow-vs-job-비교","children":[]},{"level":2,"title":"Job Document 구조","slug":"job-document-구조","link":"#job-document-구조","children":[{"level":3,"title":"예시 1: 펌웨어 업데이트","slug":"예시-1-펌웨어-업데이트","link":"#예시-1-펌웨어-업데이트","children":[]},{"level":3,"title":"예시 2: 설정 변경","slug":"예시-2-설정-변경","link":"#예시-2-설정-변경","children":[]},{"level":3,"title":"예시 3: 단순 명령","slug":"예시-3-단순-명령","link":"#예시-3-단순-명령","children":[]}]},{"level":2,"title":"Job 생성 및 관리","slug":"job-생성-및-관리","link":"#job-생성-및-관리","children":[{"level":3,"title":"CLI로 Job 생성","slug":"cli로-job-생성","link":"#cli로-job-생성","children":[]},{"level":3,"title":"디바이스에서 Job 처리","slug":"디바이스에서-job-처리","link":"#디바이스에서-job-처리","children":[]}]}]},{"level":1,"title":"5. 실무에서 배운 교훈들","slug":"_5-실무에서-배운-교훈들","link":"#_5-실무에서-배운-교훈들","children":[{"level":2,"title":"디바이스 오프라인 대응","slug":"디바이스-오프라인-대응","link":"#디바이스-오프라인-대응","children":[]},{"level":2,"title":"대규모 배포시 주의사항","slug":"대규모-배포시-주의사항","link":"#대규모-배포시-주의사항","children":[]},{"level":2,"title":"보안 관련 팁","slug":"보안-관련-팁","link":"#보안-관련-팁","children":[{"level":3,"title":"1. 인증서 로테이션","slug":"_1-인증서-로테이션","link":"#_1-인증서-로테이션","children":[]},{"level":3,"title":"2. 정책 최소권한 원칙","slug":"_2-정책-최소권한-원칙","link":"#_2-정책-최소권한-원칙","children":[]}]}]},{"level":1,"title":"6. 메시지 크기 최적화: 비용 절약의 핵심","slug":"_6-메시지-크기-최적화-비용-절약의-핵심","link":"#_6-메시지-크기-최적화-비용-절약의-핵심","children":[{"level":2,"title":"AWS IoT Core 실제 과금 방식","slug":"aws-iot-core-실제-과금-방식","link":"#aws-iot-core-실제-과금-방식","children":[{"level":3,"title":"실제 과금 구조","slug":"실제-과금-구조","link":"#실제-과금-구조","children":[]}]},{"level":2,"title":"실제 비용 영향 사례","slug":"실제-비용-영향-사례","link":"#실제-비용-영향-사례","children":[{"level":3,"title":"Before 최적화 (8KB 센서 데이터)","slug":"before-최적화-8kb-센서-데이터","link":"#before-최적화-8kb-센서-데이터","children":[]},{"level":3,"title":"After 최적화 (4.2KB 압축 데이터)","slug":"after-최적화-4-2kb-압축-데이터","link":"#after-최적화-4-2kb-압축-데이터","children":[]}]},{"level":2,"title":"월별 비용 차이 계산","slug":"월별-비용-차이-계산","link":"#월별-비용-차이-계산","children":[{"level":3,"title":"8KB 메시지 (최적화 전)","slug":"_8kb-메시지-최적화-전","link":"#_8kb-메시지-최적화-전","children":[]},{"level":3,"title":"4.2KB 메시지 (최적화 후)","slug":"_4-2kb-메시지-최적화-후","link":"#_4-2kb-메시지-최적화-후","children":[]}]},{"level":2,"title":"실무 최적화 기법들","slug":"실무-최적화-기법들","link":"#실무-최적화-기법들","children":[{"level":3,"title":"1. JSON 키 이름 축약","slug":"_1-json-키-이름-축약","link":"#_1-json-키-이름-축약","children":[]},{"level":3,"title":"2. 데이터 타입 최적화","slug":"_2-데이터-타입-최적화","link":"#_2-데이터-타입-최적화","children":[]},{"level":3,"title":"3. 배열 데이터 압축","slug":"_3-배열-데이터-압축","link":"#_3-배열-데이터-압축","children":[]},{"level":3,"title":"4. GZIP 압축 활용","slug":"_4-gzip-압축-활용","link":"#_4-gzip-압축-활용","children":[]}]},{"level":2,"title":"메시지 크기 모니터링 도구","slug":"메시지-크기-모니터링-도구","link":"#메시지-크기-모니터링-도구","children":[]},{"level":2,"title":"배치 전송으로 효율성 극대화","slug":"배치-전송으로-효율성-극대화","link":"#배치-전송으로-효율성-극대화","children":[]},{"level":2,"title":"다른 AWS IoT 서비스들도 마찬가지","slug":"다른-aws-iot-서비스들도-마찬가지","link":"#다른-aws-iot-서비스들도-마찬가지","children":[{"level":3,"title":"Device Shadow","slug":"device-shadow","link":"#device-shadow","children":[]},{"level":3,"title":"Rules Engine","slug":"rules-engine","link":"#rules-engine","children":[]}]},{"level":2,"title":"핵심 권장사항","slug":"핵심-권장사항","link":"#핵심-권장사항","children":[]}]}],"git":{},"filePathRelative":"_posts/tech/2025-06-27-iot.md"}');export{f as comp,w as data};
